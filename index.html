<!DOCTYPE html>
<html lang="fr" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korchi Abdelaziz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { brand: 'rgba(143, 91, 217, 1)', darkBg: '#0F172A', darkCard: '#1E293B' } } }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .glass-nav {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #FACC15;
        }

        .warning-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>

<body class="bg-darkBg text-white min-h-screen font-sans">

    <div id="toast-container" class="toast space-y-3"></div>

    <nav id="main-nav" class="glass-nav sticky top-0 z-50 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 font-black text-2xl text-brand italic tracking-tighter uppercase">
                <i data-lucide="zap"></i> Korchi Abdelaziz
            </div>
            <div id="nav-actions" class="flex gap-4">
                <button onclick="switchView('visitor')"
                    class="text-sm font-bold hover:text-brand transition">VISITEUR</button>
                <button onclick="switchView('admin')"
                    class="bg-brand text-black px-6 py-2 rounded-full text-sm font-black transition hover:scale-105">ADMIN</button>
            </div>
        </div>
    </nav>

    <section id="view-admin" class="container mx-auto py-10 px-4">
        <div class="max-w-4xl mx-auto space-y-8">
            <div class="bg-darkCard p-8 rounded-[2.5rem] border border-slate-700 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-brand italic uppercase">Ajouter Certificat</h2>
                    <button onclick="document.getElementById('json-input').click()"
                        class="p-3 bg-slate-800 rounded-xl hover:bg-slate-700 transition">
                        <i data-lucide="file-up" class="w-5 h-5 text-brand"></i>
                    </button>
                    <input type="file" id="json-input" class="hidden" accept=".json" onchange="importJSON(event)">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input id="in-title" type="text" placeholder="Titre (ex: AWS Cloud)"
                        class="p-4 bg-darkBg border border-slate-700 rounded-2xl outline-none focus:border-brand">
                    <input id="in-org" type="text" placeholder="Organisme"
                        class="p-4 bg-darkBg border border-slate-700 rounded-2xl outline-none focus:border-brand">
                    <input id="in-date" type="month"
                        class="p-4 bg-darkBg border border-slate-700 rounded-2xl outline-none focus:border-brand text-slate-400">
                    <input id="in-file" type="file" class="p-3 text-xs bg-darkBg border border-slate-700 rounded-2xl">
                    <textarea id="in-skills" placeholder="Skills (ex: React, Java...)"
                        class="md:col-span-2 p-4 bg-darkBg border border-slate-700 rounded-2xl h-20 outline-none focus:border-brand"></textarea>
                    <button onclick="saveCertificate()"
                        class="md:col-span-2 bg-brand text-black p-5 rounded-2xl font-black text-lg hover:brightness-110 active:scale-95 transition">PUBLIER</button>
                </div>
            </div>

            <button onclick="generateSecureLink()"
                class="w-full border-2 border-brand border-dashed p-4 rounded-2xl text-brand font-bold hover:bg-brand/5 transition flex items-center justify-center gap-3">
                <i data-lucide="link"></i> COPIER LE LIEN SÉCURISÉ POUR VISITEUR
            </button>

            <div id="admin-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    </section>

    <section id="view-visitor" class="hidden container mx-auto py-12 px-4">
        <div class="flex flex-col items-center mb-10 space-y-6">
            <div class="flex items-center gap-3 bg-darkCard p-2 px-4 rounded-full border border-slate-700">
                <i data-lucide="calendar" class="text-brand w-5 h-5"></i>
                <input type="month" id="filter-date" onchange="filterData()"
                    class="bg-transparent font-bold text-brand outline-none">
                <button onclick="clearDateFilter()" class="hover:text-red-500 transition"><i data-lucide="x-circle"
                        class="w-5 h-5"></i></button>
            </div>
            <div id="skills-scroll" class="flex gap-3 overflow-x-auto no-scrollbar w-full py-4 scroll-smooth"></div>
        </div>
        <div id="certs-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    </section>

    <div id="modal" class="hidden fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-4"
        onclick="closeModal()">
        <div class="bg-darkCard max-w-5xl w-full rounded-[3rem] overflow-hidden flex flex-col md:flex-row border border-brand/20 shadow-2xl"
            onclick="event.stopPropagation()">
            <div id="modal-img-container" class="md:w-1/2 bg-black flex items-center justify-center min-h-[400px]">
            </div>
            <div id="modal-text" class="md:w-1/2 p-12 bg-darkCard relative flex flex-col justify-center">
                <button onclick="closeModal()" class="absolute top-6 right-6 text-brand hover:scale-125 transition"><i
                        data-lucide="x"></i></button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_IMG = "https://images.unsplash.com/photo-1633158829585-23ba8f7c8caf?q=80&w=800";
        let certs = JSON.parse(localStorage.getItem('certifvault_v4')) || [];
        let activeSkill = null;

        // --- GESTION DES NOTIFICATIONS ---
        function notify(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const color = type === 'success' ? 'border-brand text-brand' : (type === 'error' ? 'border-red-500 text-red-500' : 'border-orange-500 text-orange-500');
            const toast = document.createElement('div');
            toast.className = `p-4 rounded-xl bg-darkCard border-l-4 shadow-2xl animate__animated animate__fadeInRight flex items-center gap-3 font-bold text-sm ${color}`;
            toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}"></i> ${msg}`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => { toast.classList.replace('animate__fadeInRight', 'animate__fadeOutRight'); setTimeout(() => toast.remove(), 500); }, 3000);
        }

        // --- VUES ---
        function switchView(view) {
            document.getElementById('view-admin').classList.toggle('hidden', view !== 'admin');
            document.getElementById('view-visitor').classList.toggle('hidden', view !== 'visitor');
            if (view === 'admin') renderAdminList();
            if (view === 'visitor') { renderSkillsScroll(); filterData(); }
            lucide.createIcons();
        }

        // --- SAUVEGARDE ET VALIDATION INTÉLLIGENTE ---
        async function saveCertificate() {
            const fileInput = document.getElementById('in-file');
            const title = document.getElementById('in-title').value;
            const org = document.getElementById('in-org').value;

            let fileData = DEFAULT_IMG;
            if (fileInput.files[0]) {
                fileData = await new Promise(res => {
                    const reader = new FileReader();
                    reader.onload = e => res(e.target.result);
                    reader.readAsDataURL(fileInput.files[0]);
                });
            }

            const newCert = {
                id: Date.now(),
                title: title || "",
                org: org || "",
                date: document.getElementById('in-date').value || "",
                skills: document.getElementById('in-skills').value.split(',').map(s => s.trim()).filter(s => s),
                file: fileData
            };

            certs.push(newCert);
            localStorage.setItem('certifvault_v4', JSON.stringify(certs));

            if (!title || !org || !newCert.date) {
                notify("Certificat ajouté avec des champs manquants !", "warning");
            } else {
                notify("Publication réussie !");
            }

            renderAdminList();
            // Reset fields
            ['in-title', 'in-org', 'in-date', 'in-skills'].forEach(id => document.getElementById(id).value = "");
        }

        // --- RENDU ADMIN AVEC ÉDITION ---
        function renderAdminList() {
            const list = document.getElementById('admin-list');
            list.innerHTML = certs.map(c => `
                <div class="bg-darkCard p-6 rounded-3xl border ${(!c.title || !c.org || !c.date) ? 'border-orange-500/50' : 'border-slate-700'} relative">
                    <button onclick="deleteCert(${c.id})" class="absolute top-4 right-4 text-red-500 hover:scale-110 transition"><i data-lucide="trash-2"></i></button>
                    <div class="space-y-3">
                        ${!c.title ? `<p class="text-orange-500 text-[10px] font-black warning-pulse">⚠️ TITRE MANQUANT</p>` : ''}
                        <input onchange="updateCert(${c.id}, 'title', this.value)" value="${c.title}" placeholder="Titre..." class="w-full bg-transparent font-bold text-lg outline-none focus:text-brand">
                        
                        ${!c.org ? `<p class="text-orange-500 text-[10px] font-black warning-pulse">⚠️ ORGANISME MANQUANT</p>` : ''}
                        <input onchange="updateCert(${c.id}, 'org', this.value)" value="${c.org}" placeholder="Organisme..." class="w-full bg-transparent text-sm text-slate-400 outline-none focus:text-brand">
                        
                        ${!c.date ? `<p class="text-orange-500 text-[10px] font-black warning-pulse">⚠️ DATE MANQUANTE</p>` : ''}
                        <input type="month" onchange="updateCert(${c.id}, 'date', this.value)" value="${c.date}" class="bg-transparent text-xs text-brand outline-none">
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function updateCert(id, field, value) {
            const index = certs.findIndex(c => c.id === id);
            certs[index][field] = value;
            localStorage.setItem('certifvault_v4', JSON.stringify(certs));
            notify("Mise à jour effectuée");
            renderAdminList();
        }

        function deleteCert(id) {
            certs = certs.filter(c => c.id !== id);
            localStorage.setItem('certifvault_v4', JSON.stringify(certs));
            notify("Supprimé", "error");
            renderAdminList();
        }

        // --- VISITEUR ET FILTRES ---
        function clearDateFilter() { document.getElementById('filter-date').value = ""; filterData(); }

        function renderSkillsScroll() {
            const scroll = document.getElementById('skills-scroll');
            const allSkills = [...new Set(certs.flatMap(c => c.skills))];
            scroll.innerHTML = `<button onclick="setSkillFilter(null)" class="flex-shrink-0 px-6 py-2 rounded-full border-2 border-slate-700 font-black transition ${!activeSkill ? 'bg-brand text-black border-brand' : ''}">ALL</button>`;
            allSkills.forEach(s => {
                scroll.innerHTML += `<button onclick="setSkillFilter('${s}')" class="flex-shrink-0 px-6 py-2 rounded-full border-2 border-slate-700 font-black transition ${activeSkill === s ? 'bg-brand text-black border-brand' : ''}">#${s.toUpperCase()}</button>`;
            });
        }

        function setSkillFilter(s) { activeSkill = s; renderSkillsScroll(); filterData(); }

        function filterData() {
            const dateVal = document.getElementById('filter-date').value;
            const filtered = certs.filter(c => {
                const matchDate = dateVal ? c.date === dateVal : true;
                const matchSkill = activeSkill ? c.skills.includes(activeSkill) : true;
                return matchDate && matchSkill && c.title && c.org; // Cache les incomplets aux visiteurs
            });
            renderGrid(filtered);
        }

        function renderGrid(data) {
            const grid = document.getElementById('certs-grid');
            grid.innerHTML = data.map((c, i) => `
                <div class="bg-darkCard rounded-[2.5rem] overflow-hidden border border-slate-700 hover:border-brand transition shadow-2xl group animate__animated animate__fadeInUp" style="animation-delay: ${i * 0.05}s">
                    <div class="h-48 overflow-hidden"><img src="${c.file}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500"></div>
                    <div class="p-8">
                        <p class="text-brand font-black text-[10px] tracking-widest mb-1 uppercase">${c.org} • ${c.date}</p>
                        <h3 class="text-xl font-bold mb-6 h-12 line-clamp-2">${c.title}</h3>
                        <button onclick="openDetails(${c.id})" class="w-full py-3 bg-brand text-black rounded-xl font-black text-xs hover:brightness-110 transition">DÉTAILS</button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function openDetails(id) {
            const c = certs.find(i => i.id === id);
            const modal = document.getElementById('modal');
            document.getElementById('modal-img-container').innerHTML = c.file.includes('pdf') ?
                `<iframe src="${c.file}" class="w-full h-full border-none"></iframe>` :
                `<img src="${c.file}" class="max-h-full p-4 object-contain">`;
            document.getElementById('modal-text').innerHTML = `
                <h2 class="text-4xl font-black mb-2 italic text-brand leading-none">${c.title}</h2>
                <p class="text-white font-bold text-xl mb-6">${c.org}</p>
                <div class="flex flex-wrap gap-2">
                    ${c.skills.map(s => `<span class="bg-slate-800 text-slate-300 px-4 py-2 rounded-xl text-xs font-bold border border-slate-700">#${s.toUpperCase()}</span>`).join('')}
                </div>
            `;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function generateSecureLink() {
            const secureURL = window.location.origin + window.location.pathname + "?view=public";
            navigator.clipboard.writeText(secureURL);
            notify("Lien sécurisé copié !");
        }

        function importJSON(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const imported = JSON.parse(ev.target.result);
                certs = [...certs, ...imported.map(i => ({ ...i, id: Date.now() + Math.random(), file: i.file || DEFAULT_IMG }))];
                localStorage.setItem('certifvault_v4', JSON.stringify(certs));
                location.reload();
            };
            reader.readAsText(e.target.files[0]);
        }

        window.onload = () => {
            const p = new URLSearchParams(window.location.search);
            if (p.has('view')) {
                document.getElementById('main-nav').style.display = 'none';
                switchView('visitor');
            } else { switchView('admin'); }
        };
    </script>
</body>

</html>